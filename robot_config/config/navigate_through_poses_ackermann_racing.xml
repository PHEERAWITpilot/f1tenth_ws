<root BTCPP_format="4" main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <!-- ✅ ONLY 2 retries for Ackermann (no reverse/spin available) -->
    <RecoveryNode number_of_retries="2" name="NavigateRecovery">
      <PipelineSequence name="NavigateWithReplanning">
        
        <!-- ✅ FAST replanning (every 1 second) for dynamic obstacles -->
        <RateController hz="1.0">
          <!-- ✅ SINGLE retry for planning (fail fast with 0.5m waypoints) -->
          <RecoveryNode number_of_retries="1" name="ComputePathThroughPoses">
            <ReactiveSequence>
              
              <!-- ✅ CRITICAL: radius=0.3m for 0.5m waypoint spacing -->
              <RemovePassedGoals 
                input_goals="{goals}" 
                output_goals="{goals}" 
                radius="0.9"
                input_waypoint_statuses="{waypoint_statuses}"
                output_waypoint_statuses="{waypoint_statuses}"/>
              
              <ComputePathThroughPoses 
                goals="{goals}" 
                path="{path}" 
                planner_id="GridBased"
                error_code_id="{compute_path_error_code}"/>
            </ReactiveSequence>
            
            <!-- ✅ Recovery: Clear global costmap ONLY (no spin/backup) -->
            <ReactiveFallback name="ComputePathRecovery">
              <GoalUpdated/>
              <ClearEntireCostmap 
                name="ClearGlobalCostmap" 
                service_name="global_costmap/clear_entirely_global_costmap"/>
            </ReactiveFallback>
          </RecoveryNode>
        </RateController>

        <!-- ✅ Path following with local costmap clearing fallback -->
        <RecoveryNode number_of_retries="1" name="FollowPath">
          <FollowPath 
            path="{path}" 
            controller_id="FollowPath"
            error_code_id="{follow_path_error_code}"
            goal_checker_id="general_goal_checker"/>
          
          <ReactiveFallback name="FollowPathRecovery">
            <GoalUpdated/>
            <ClearEntireCostmap 
              name="ClearLocalCostmap" 
              service_name="local_costmap/clear_entirely_local_costmap"/>
          </ReactiveFallback>
        </RecoveryNode>
        
      </PipelineSequence>

      <!-- ✅ System-level recovery: WAIT ONLY (no backup/spin for Ackermann) -->
      <ReactiveFallback name="RecoveryFallback">
        <GoalUpdated/>
        <Sequence name="ClearAndWait">
          <ClearEntireCostmap 
            name="ClearBothCostmaps" 
            service_name="local_costmap/clear_entirely_local_costmap"/>
          <ClearEntireCostmap 
            name="ClearGlobalToo" 
            service_name="global_costmap/clear_entirely_global_costmap"/>
          <Wait wait_duration="1.5"/>  <!-- ✅ Short wait for racing -->
        </Sequence>
      </ReactiveFallback>
    </RecoveryNode>
  </BehaviorTree>
</root>
