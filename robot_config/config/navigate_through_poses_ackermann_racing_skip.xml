<root BTCPP_format="4" main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <RecoveryNode number_of_retries="5" name="NavigateRecovery">
      <PipelineSequence name="NavigateWithReplanning">
        
        <RateController hz="3.0">
          <RecoveryNode number_of_retries="2" name="ComputePathThroughPoses">
            <ReactiveSequence>
              
              <!-- âœ… STEP 1: Remove waypoints we've already passed -->
              <RemovePassedGoals 
                input_goals="{goals}" 
                output_goals="{goals}" 
                radius="1.0" 
                input_waypoint_statuses="{waypoint_statuses}"
                output_waypoint_statuses="{waypoint_statuses}"/>
              
              <!-- ðŸ”¥ STEP 2: NEW! Skip waypoints blocked by obstacles -->
              <RemoveInCollisionGoals 
                input_goals="{goals}" 
                output_goals="{goals}"
                cost_threshold="200.0"
                use_footprint="true"
                consider_unknown_as_obstacle="false"
                service_name="/global_costmap/get_cost_global_costmap"
                input_waypoint_statuses="{waypoint_statuses}"
                output_waypoint_statuses="{waypoint_statuses}"/>
              
              <!-- âœ… STEP 3: Plan to remaining valid waypoints -->
              <ComputePathThroughPoses 
                goals="{goals}" 
                path="{path}" 
                planner_id="GridBased"
                error_code_id="{compute_path_error_code}"/>
            </ReactiveSequence>
            
            <ReactiveFallback name="ComputePathRecovery">
              <GoalUpdated/>
              <ClearEntireCostmap 
                name="ClearGlobalCostmap" 
                service_name="global_costmap/clear_entirely_global_costmap"/>
            </ReactiveFallback>
          </RecoveryNode>
        </RateController>
        
        <IsPathValid
            path="{path}"
            is_path_valid="{is_path_valid}"/>
        
        <RecoveryNode number_of_retries="2" name="FollowPath">
          <FollowPath 
            path="{path}" 
            controller_id="FollowPath"
            error_code_id="{follow_path_error_code}"
            goal_checker_id="general_goal_checker"/>
          
          <ReactiveFallback name="FollowPathRecovery">
            <GoalUpdated/>
            <ClearEntireCostmap 
              name="ClearLocalCostmap" 
              service_name="local_costmap/clear_entirely_local_costmap"/>
          </ReactiveFallback>
        </RecoveryNode>
        
      </PipelineSequence>

      <ReactiveFallback name="RecoveryFallback">
        <GoalUpdated/>
        <Sequence name="ClearAndWait">
          <ClearEntireCostmap 
            name="ClearBothCostmaps" 
            service_name="local_costmap/clear_entirely_local_costmap"/>
          <ClearEntireCostmap 
            name="ClearGlobalToo" 
            service_name="global_costmap/clear_entirely_global_costmap"/>
          <Wait wait_duration="0.5"/>
        </Sequence>
      </ReactiveFallback>
    </RecoveryNode>
  </BehaviorTree>
</root>
